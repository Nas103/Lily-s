generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  name            String?
  passwordHash    String
  role            UserRole @default(USER)
  phone           String?
  dateOfBirth     DateTime?
  country         String?
  city            String?
  postcode        String?
  addressLine1    String?
  addressLine2    String?
  profileImageUrl String?  // URL to user's profile image
  profileVisibility String? @default("PRIVATE") // PRIVATE, SOCIAL, PUBLIC
  locationSharing Boolean  @default(false)
  emailNotifications Boolean @default(true)
  smsNotifications Boolean @default(false)
  marketingEmails Boolean @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  orders          Order[]
  deliveryAddresses DeliveryAddress[]
  paymentMethods  PaymentMethod[]
}

model DeliveryAddress {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label       String   // e.g., "Home", "Work", "Office"
  fullName    String   // Recipient full name
  phone       String?  // Phone number for delivery
  addressLine1 String
  addressLine2 String?
  city        String
  state       String?  // State/Province
  postcode    String
  country     String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

enum UserRole {
  USER
  ADMIN
}

model Category {
  id        String    @id @default(uuid())
  name      String
  slug      String    @unique
  createdAt DateTime  @default(now())
  products  Product[]
}

model Product {
  id          String      @id @default(uuid())
  name        String
  slug        String      @unique
  description String
  price       Decimal     @db.Decimal(10, 2)
  imageUrl    String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  categoryId  String
  category    Category    @relation(fields: [categoryId], references: [id])
  orderItems  OrderItem[]
}

model Order {
  id          String      @id @default(uuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id])
  total       Decimal     @db.Decimal(10, 2)
  createdAt   DateTime    @default(now())
  orderItems  OrderItem[]
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
}

model PaymentMethod {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          PaymentType
  cardLast4     String?  // Last 4 digits only (e.g., "1234")
  cardBrand     String?  // e.g., "Visa", "Mastercard", "American Express"
  expiryMonth   Int?     // 1-12
  expiryYear    Int?     // YYYY format
  holderName    String?  // Cardholder name
  isDefault     Boolean  @default(false)
  // Payment processor token (e.g., PayFast token, Stripe payment method ID)
  // Never store full card numbers or CVV
  processorToken String? // Encrypted token from payment processor
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

enum PaymentType {
  CARD
  BANK_ACCOUNT
  E_WALLET
}


